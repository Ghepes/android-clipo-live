steps:
  # PAS 0: DESCĂRCAREA ZIP-ULUI
  - name: 'gcr.io/cloud-builders/gsutil'
    args: ['cp', 'gs://$_BUCKET/$_OBJECT', 'input.zip']

  # PAS 1: Dezarhivare
  - name: 'bash'
    args: ['bash', '-c', 'unzip -o input.zip']

  # PAS 2: Generare Keystore
  - name: 'gcr.io/cloud-builders/java/azul'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        keytool -genkey -v -keystore release-key.jks -keyalg RSA \
        -keysize 2048 -validity 10000 -alias key0 \
        -dname "CN=AndroidApp, OU=IT, O=AutoGenerated, L=Web, C=AT" \
        -storepass android -keypass android

  # PAS 3: INSTALARE SDK + GRADLE + COMPILARE
  # Folosim 'ubuntu' Cloud Build.
  - name: 'ubuntu:22.04'
    entrypoint: 'bash'
    env:
      - 'DEBIAN_FRONTEND=noninteractive'
    args:
      - '-c'
      - |
        echo "1. Instalez Java și unelte..."
        apt-get update -qq && apt-get install -y openjdk-17-jdk wget unzip zip -qq

        echo "2. Pregătesc Android SDK..."
        mkdir -p /workspace/android-sdk/cmdline-tools
        
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -O android_tools.zip
        unzip -q android_tools.zip -d /workspace/android-sdk/cmdline-tools
        mv /workspace/android-sdk/cmdline-tools/cmdline-tools /workspace/android-sdk/cmdline-tools/latest
        
        # Setăm PATH-ul folosind $$ pentru a evita eroarea de substituție
        export ANDROID_HOME=/workspace/android-sdk
        export PATH=$$PATH:$$ANDROID_HOME/cmdline-tools/latest/bin:$$ANDROID_HOME/platform-tools

        echo "3. Accept Licențele..."
        yes | sdkmanager --licenses > /dev/null
        
        echo "4. Instalez Platformele..."
        sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0" > /dev/null

        echo "5. Descarc Gradle..."
        wget -q https://services.gradle.org/distributions/gradle-8.5-bin.zip
        unzip -q gradle-8.5-bin.zip

        echo "6. START COMPILARE..."
        # Rulăm Gradle specificând explicit unde e SDK-ul
        ./gradle-8.5/bin/gradle bundleRelease -Dsdk.dir=/workspace/android-sdk

  # PAS 4: Împachetare Finală
  - name: 'bash'
    args: ['zip', '-j', 'final-app.zip', 'app/build/outputs/bundle/release/app-release.aab', 'release-key.jks']

# Exportăm rezultatul
artifacts:
  objects:
    location: 'gs://$_OUTPUT_BUCKET/'
    paths: ['final-app.zip']

options:
  logging: CLOUD_LOGGING_ONLY

